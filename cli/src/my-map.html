<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/google-map/google-map.html">
<link rel="import" href="../bower_components/google-map/google-map-marker.html">
<link rel="import" href="../bower_components/google-apis/google-maps-api.html">

<link rel="import" href="mi-rpc.html">
<link rel="import" href="mi-helper.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-map">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }
      google-map {
        height: 600px;
        width: auto;
        margin: 10px auto;
      }
    </style>

    <div class="card">
      <h1>Carte des centres de recherches</h1>
      <p>Les centres de recherches de l'INRIA sont trouvables ici<p>
      <google-map fit-to-markers id="map" api-key="AIzaSyBoFJIoqc8uOyt9Tui2MohrLxIgbrXsHl0"></google-map>
    </div>
    <mi-helper id="helper"></mi-helper>
    <mi-rpc id="rpc"></mi-rpc>
  </template>

  <script>
    class MyMap extends Polymer.Element {
      static get is() { return 'my-map'; }

      /**
       *  Properties
       */
      static get properties() {
        return {
          defLat: {
            type: String,
            value: "46.508689"
          },
          defLon: {
            type: String,
            value: "2.6393036"
          },
          defZoom: {
            type: Number,
            value: 5
          },
          routeUrl: {
            type: String,
            value: "centers/list"
          },
          helper: Object,
          rpc: Object,
          map: Object,
          _shadowRoot: Object
        };
      }

      /**
       *  construct lifecycle
       */
      constructor(){
        super();
        // For getting the bubbles
        this._shadowRoot = this.attachShadow({ mode: 'open' });

        // Listen on RPCEvent fire from mi-rpc component
        this._shadowRoot.addEventListener('rpcError', (event) => this._onRpcError(event));
        this._shadowRoot.addEventListener('rpcResponse', (event) => this._onRpcResponse(event));
      }

      connectedCallback(){
        super.connectedCallback();
      }

      /**
       *  ready lifecycle
       */
      ready() {
        super.ready();
        // Get utilities
        this.helper = this.shadowRoot.getElementById('helper');
        this.rpc = this.shadowRoot.getElementById('rpc');
        // Configure map
        this.map = this.shadowRoot.getElementById('map');
        this.map.latitude = this.defLat;
        this.map.longitude = this.defLon;
        this.map.zoom = this.defZoom;
        // Launch Ajax call for getting the centers list
        this.rpc.sendData(this.routeUrl, "GET");
      }

      // Action on RPC Error
      _onRpcError(event){
        debugger;
        this.helper.showToast("Impossible de récupérer les infos depuis le serveur");
        console.log(event);
      }

      // Action on RPC Response
      _onRpcResponse(event){
        this.helper.showToast("Informations reçues depuis le serveur");
        const response = event.detail.data.response;
        // Create markers and add it to the map
        const crs = response[0].cr;
        let i = 0;
        while(i < crs.length){
          this._addMarker(crs[i].adressegeographique);
          i++;
        }
      }

      // Add marker on the map
      _addMarker(data){
        let marker = document.createElement('google-map-marker');
        marker.latitude = data.latitude;
        marker.longitude = data.longitude;
        marker.title = data.libelle;
        marker.appendChild(this._createInfo(data));
        marker.clickEvents = true;
        marker.addEventListener('google-map-marker-click', function(event){
          let marker = event.target;
          marker.open = true;
        });
        this.map.appendChild(marker);
      }

      _createInfo(data){
        let element = document.createElement('h2');
        element.innerHTML = 'Salut';
        return element;
      }
    }

    window.customElements.define(MyMap.is, MyMap);
  </script>
</dom-module>
